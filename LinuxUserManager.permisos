#!/bin/bash

modificar_permisos() {
    clear
    echo "### Gestión de permisos ACL para carpetas compartidas ###"

    # Solicitar ruta base de carpetas compartidas
    read -p "Ingrese la ruta donde están las carpetas compartidas (ej: /home/compartido): " ruta_compartida

    # Verificar que la ruta existe
    if [ ! -d "$ruta_compartida" ]; then
        echo "La ruta especificada no existe."
        exit 1
    fi

    # Listar carpetas en esa ruta
    echo -e "\nCarpetas encontradas en $ruta_compartida:"
    carpetas=($(ls -1 "$ruta_compartida"))
    for carpeta in "${carpetas[@]}"; do
        echo " - $carpeta"
    done

    # Listar usuarios del sistema (excluye usuarios del sistema con UID < 1000)
    echo -e "\nUsuarios del sistema:"
    usuarios=($(awk -F: '$3 >= 1000 && $1 != "nobody" { print $1 }' /etc/passwd))
    for usuario in "${usuarios[@]}"; do
        echo " - $usuario"
    done

    # Mostrar permisos actuales
    echo -e "\nPermisos ACL actuales por carpeta y usuario:"
    for carpeta in "${carpetas[@]}"; do
        echo -e "\n--- $carpeta ---"
        getfacl -p "$ruta_compartida/$carpeta" | grep '^user:' | grep -v 'user::'
    done

    # Modificar permisos
    echo -e "\nAhora puede modificar permisos."

    for usuario in "${usuarios[@]}"; do
        for carpeta in "${carpetas[@]}"; do
            echo -e "\nSeleccione el tipo de acceso para el usuario '$usuario' en la carpeta '$carpeta':"
            echo "  1) Control total (rwx)"
            echo "  2) Solo lectura (rx)"
            echo "  3) Sin acceso"
            echo "  Enter) Mantener permisos actuales"
            read -p "Opción [1-3 o Enter]: " opcion

            case $opcion in
                1)
                    sudo setfacl -R -m u:$usuario:rwx "$ruta_compartida/$carpeta"
                    echo " -> Se otorgó control total a $usuario en $carpeta"
                    ;;
                2)
                    sudo setfacl -R -m u:$usuario:rx "$ruta_compartida/$carpeta"
                    echo " -> Se otorgó solo lectura a $usuario en $carpeta"
                    ;;
                3)
                    sudo setfacl -R -m u:$usuario:--- "$ruta_compartida/$carpeta"
                    echo " -> Se eliminó el acceso de $usuario en $carpeta"
                    ;;
                "")
                    echo " -> Permisos actuales mantenidos para $usuario en $carpeta"
                    ;;
                *)
                    echo " -> Opción no válida. No se aplicó ningún cambio para $usuario en $carpeta."
                    ;;
            esac
        done
    done

    echo -e "\nCambios de permisos finalizados."
}

if [[ $EUID -ne 0 ]]; then
    echo "Este script debe ser ejecutado como root."
    exit 1
fi
modificar_permisos
